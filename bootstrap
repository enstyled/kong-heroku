#!/bin/bash
set -e

echo "> Binding to port $PORT"
export KONG_PROXY_LISTEN="0.0.0.0:$PORT reuseport backlog=16384"


echo "> Parsing the database settings"
# Parse the database URL
url="$DATABASE_URL"
dbtype=${url%%://*}
url_without_scheme=${url#*://}  # strip URL scheme
rest=${url_without_scheme#*/}
user_password_host_port=${url_without_scheme%%/*}
host_port=${user_password_host_port#*@}
user_password=${user_password_host_port%$host_port}
user_password=${user_password%@}
host=${host_port%:*}
port=${host_port#$host}
port=${port#:}
user=${user_password%:*}
password=${user_password#$user}
password=${password#:}
dbname=${rest%\?*}
querystring=${rest#$dbname}

# Set Kong database settings
export KONG_PG_HOST=$host
export KONG_PG_PORT=$port
export KONG_PG_USER=$user
export KONG_PG_PASSWORD=$password
export KONG_PG_DATABASE=$database


echo "> Starting Kong..."
./docker-entrypoint.sh kong docker-start